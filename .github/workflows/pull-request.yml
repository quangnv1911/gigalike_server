name: 🔍 Pull Request Checks

on:
  pull_request:
    branches: [main, staging]

jobs:
  lint-and-format:
    name: 🎨 Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: 🎨 Check Code Formatting
        run: |
          mvn spotless:check
          
      - name: 📝 Checkstyle Analysis
        run: |
          mvn checkstyle:check

  unit-tests:
    name: 🧪 Unit Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test_db
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306
      
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        options: >-
          --health-cmd="echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 27017:27017

    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: 🧪 Run Unit Tests
        run: |
          mvn clean test -B
        env:
          SPRING_PROFILES_ACTIVE: test
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/test_db
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: password

      - name: 📊 Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: target/surefire-reports/*.xml

  integration-tests:
    name: 🔗 Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: 🐳 Start Test Environment
        run: |
          docker-compose -f docker-compose.test.yml up -d
          sleep 30

      - name: 🔗 Run Integration Tests
        run: |
          mvn clean verify -B -Dspring.profiles.active=integration-test

      - name: 🛑 Stop Test Environment
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml down

  security-scan:
    name: 🔒 Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: 🔍 Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'

      - name: 🔒 Run Snyk Security Check
        uses: snyk/actions/maven@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  build-check:
    name: 🏗️ Build Check
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [
          eureka-server,
          config-server, 
          api-gateway,
          auth-service,
          product-service,
          order-service,
          payment-service,
          platform-service
        ]
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: 🏗️ Build Parent Project
        run: mvn clean install -DskipTests

      - name: 🏗️ Build Service
        working-directory: ./${{ matrix.service }}
        run: mvn clean package -DskipTests

      - name: 🐳 Build Docker Image
        working-directory: ./${{ matrix.service }}
        run: |
          if [ ! -f Dockerfile ]; then
            echo "Creating Dockerfile for ${{ matrix.service }}"
            cat > Dockerfile << 'EOF'
          FROM openjdk:17-jdk-slim
          
          WORKDIR /app
          
          COPY target/*.jar app.jar
          
          EXPOSE 8080
          
          ENTRYPOINT ["java", "-jar", "app.jar"]
          EOF
          fi
          docker build -t ${{ matrix.service }}:pr-${{ github.event.number }} .

  performance-test:
    name: ⚡ Performance Tests
    runs-on: ubuntu-latest
    if: github.base_ref == 'main'
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 🚀 Start Application
        run: |
          mvn clean install -DskipTests
          docker-compose -f docker-compose.perf.yml up -d
          sleep 60

      - name: ⚡ Run JMeter Performance Tests
        uses: rbhadti94/apache-jmeter-action@v0.5.0
        with:
          testFilePath: src/test/jmeter/performance-test.jmx
          outputReportsFolder: reports/

      - name: 📊 Upload Performance Report
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: reports/

  comment-pr:
    name: 💬 Comment on PR
    runs-on: ubuntu-latest
    needs: [lint-and-format, unit-tests, integration-tests, security-scan, build-check]
    if: always()
    
    steps:
      - name: 💬 Comment PR Results
        uses: actions/github-script@v6
        with:
          script: |
            const results = {
              'lint-and-format': '${{ needs.lint-and-format.result }}',
              'unit-tests': '${{ needs.unit-tests.result }}',
              'integration-tests': '${{ needs.integration-tests.result }}',
              'security-scan': '${{ needs.security-scan.result }}',
              'build-check': '${{ needs.build-check.result }}'
            };
            
            let status = '✅ All checks passed!';
            let hasFailures = false;
            
            for (const [job, result] of Object.entries(results)) {
              if (result === 'failure') {
                hasFailures = true;
                break;
              }
            }
            
            if (hasFailures) {
              status = '❌ Some checks failed. Please review the results above.';
            }
            
            const body = `
            ## 🔍 Pull Request Check Results
            
            | Check | Status |
            |-------|--------|
            | 🎨 Code Quality | ${{ needs.lint-and-format.result == 'success' && '✅ Passed' || '❌ Failed' }} |
            | 🧪 Unit Tests | ${{ needs.unit-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |
            | 🔗 Integration Tests | ${{ needs.integration-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |
            | 🔒 Security Scan | ${{ needs.security-scan.result == 'success' && '✅ Passed' || '❌ Failed' }} |
            | 🏗️ Build Check | ${{ needs.build-check.result == 'success' && '✅ Passed' || '❌ Failed' }} |
            
            ${status}
            
            ---
            🤖 *Automated check by GitHub Actions*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
